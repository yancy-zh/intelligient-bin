# 背景

生产执行系统中，物料由标准尺寸的物料箱进行配送和加工一线的辅助工作，物料余量状态的实时监控可作为判断填充物料时机的重要手段，如果加工线上第一排的物料盒已经稀甚至几乎没有，可视为填充物料的临界时间点。如果依靠工作人员去发现物料的减少并补充所缺物料，一是可能会由于工作人员疏忽而漏查物料，导致加工线节奏的中断和工人等候，二是可能会耗费较大的人力物力来确保物料及时供给。近年来，工业智能化、自动化概念的提出，为适应物联生态的发展和提高生产水平以及效率，设计了该基于图像的物料余量监控方案。

# 技术思路

## 图像获取模块

采集装置包括一个 PCB（可编程控制板）板，供电 3.6V，其包括相机、LED 灯、微控制器等。该装置在激活状态下自动抓取一个图像流，并传回给指定网关来进行后处理。LED 为图像提供光线不足情况下额外的照明。采集装置安装在物料盒内部的活动门的对面，可以兼顾照明条件的满足和内部情况的采集。
![图像采集装置](https://github.com/yancy-zh/intelligient-bin/blob/main/assets/imgs/Snipaste_2022-10-17_18-16-12.PNG?raw=true "图像采集装置")
![图像采集装置安装于盒子内部](https://github.com/yancy-zh/intelligient-bin/blob/main/assets/imgs/Snipaste_2022-10-17_18-37-52.PNG?raw=true "图像采集装置安装于盒子内部")
图像获取模块实现对抓取的原始图像的格式转换（RAW 到 jPEG）、压缩、编码（无损压缩算法将在算法讲解视频中进行详细介绍）。

### 高阶图像处理技术

以下方法均可在一定性能需求下达到改进图像识别质量的目的。

- 去噪
- 直方图均衡化
- 图像分割
- 模式识别

### 基线处理结果

标准的盒内场景识别结果见下图
![识别结果](https://github.com/yancy-zh/intelligient-bin/blob/main/assets/imgs/Snipaste_2022-10-18_20-27-42.PNG?raw=true "A：原始图片，B：过滤后图片，C:基于局部特征的识别结果，D：Canny Edge识别结果")

### 结论

图像的处理、过滤等计算无法在现有 PCB 上进行，因为

- 模块上的有限缓存，导致图像的处理结果没有足够的存储空间，调整 buffer 的排列顺序也不能解决问题。
- 电池寿命，图像处理流程会加大电池消耗。
  后期待优化工作：
- 受摄像头摆放位置的影响，所摄图像包含较多的黑色像素。
- 物料材质的判断可能有助于改进图像处理算法的精度。

## 图像处理算法

### 介绍

该项目感兴趣区域的识别使用了图像处理算法。为应对生产线上复杂的光线背景，消除无关信息，本文使用箱底的交错线作为检测特征。像素到物料容量的映射函数是通过测量容器的几何尺寸，建模、多项式拟合而成的。

### 图像预处理

预处理使用了除噪滤波器，分两种场景 1-过度曝光 2-未饱和的图像来考虑。
![曝光过度图像](https://github.com/yancy-zh/intelligient-bin/blob/main/assets/imgs/Snipaste_2022-10-18_20-27-44.PNG?raw=true "曝光过度图像")

### 特征提取

算法的核心是 BRISK，它能够通过映射算法来实现山脊线（盒子多个面的过渡）的识别，为提高鲁棒性，特征点的注册需要通过空间转换来实现。图像金字塔和下采样将被使用。参数设置请详见讲解视频。
![BRISK角点探测](https://github.com/yancy-zh/intelligient-bin/blob/main/assets/imgs/Snipaste_2022-10-20_19-56-11.PNG?raw=true "BRISK角点探测")

## 识别物料余量

## 边缘计算模块
